{% extends "base.html" %}

{% block title %}Dashboard - FileVault{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <div class="dashboard-welcome">
            <h1>Welcome, {{ user.username }}!</h1>
            <p>Manage your files securely</p>
        </div>
        <div class="dashboard-stats">
            <div class="stat-card">
                <i class="fas fa-file"></i>
                <div class="stat-info">
                    <span class="stat-value">{{ files|length }}</span>
                    <span class="stat-label">Total Files</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <form class="upload-form" method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" id="uploadForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="upload-area" id="uploadArea">
                <input type="file" name="file" id="fileInput" class="file-input" required>
                <div class="upload-content">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h3>Drag & Drop your file here</h3>
                    <p>or click to browse</p>
                    <span class="upload-hint">Supports: Images, PDFs, Documents, Videos, Audio (Max 16MB)</span>
                </div>
                <div class="file-preview" id="filePreview" style="display: none;">
                    <i class="fas fa-file" id="previewIcon"></i>
                    <span id="fileName"></span>
                    <span id="fileSize"></span>
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-upload" id="uploadBtn" disabled>
                <i class="fas fa-upload"></i>
                Upload File
            </button>
        </form>
    </div>

    <!-- Files Section -->
    <div class="files-section">
        <div class="files-header">
            <h2><i class="fas fa-folder-open"></i> Your Files</h2>
            <div class="files-view-toggle">
                <button class="view-btn active" data-view="grid" title="Grid View">
                    <i class="fas fa-th-large"></i>
                </button>
                <button class="view-btn" data-view="list" title="List View">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>

        {% if files %}
            <div class="files-grid" id="filesContainer">
                {% for file in files %}
                    <div class="file-card">
                        <a href="{{ url_for('view_file', file_id=file.id) }}" class="file-card-link">
                            <div class="file-thumbnail">
                                {% if file.is_image() %}
                                    <img src="{{ url_for('serve_file', filename=file.stored_filename) }}" alt="{{ file.original_filename }}">
                                {% else %}
                                    <i class="fas {{ file.get_file_icon() }}"></i>
                                {% endif %}
                            </div>
                            <div class="file-info">
                                <h4 class="file-name" title="{{ file.original_filename }}">{{ file.original_filename }}</h4>
                                <div class="file-meta">
                                    <span><i class="fas fa-hdd"></i> {{ file.formatted_size }}</span>
                                    <span><i class="fas fa-clock"></i> {{ file.uploaded_at.strftime('%b %d, %Y') }}</span>
                                </div>
                            </div>
                        </a>
                        <div class="file-actions">
                            <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-sm btn-secondary" title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                            <form method="POST" action="{{ url_for('delete_file', file_id=file.id) }}" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>No files yet</h3>
                <p>Upload your first file to get started!</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // File upload drag and drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const uploadContent = document.querySelector('.upload-content');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const previewIcon = document.getElementById('previewIcon');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        uploadArea.classList.add('drag-over');
    }

    function unhighlight() {
        uploadArea.classList.remove('drag-over');
    }

    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        updatePreview(files[0]);
    }

    fileInput.addEventListener('change', function() {
        if (this.files[0]) {
            updatePreview(this.files[0]);
        }
    });

    function updatePreview(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        const ext = file.name.split('.').pop().toLowerCase();
        const iconMap = {
            'png': 'fa-image', 'jpg': 'fa-image', 'jpeg': 'fa-image', 'gif': 'fa-image',
            'pdf': 'fa-file-pdf',
            'doc': 'fa-file-word', 'docx': 'fa-file-word',
            'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel', 'csv': 'fa-file-excel',
            'mp4': 'fa-file-video',
            'mp3': 'fa-file-audio',
            'zip': 'fa-file-archive'
        };
        previewIcon.className = 'fas ' + (iconMap[ext] || 'fa-file');
        
        uploadContent.style.display = 'none';
        filePreview.style.display = 'flex';
        uploadBtn.disabled = false;
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // View toggle
    const viewBtns = document.querySelectorAll('.view-btn');
    const filesContainer = document.getElementById('filesContainer');

    viewBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            viewBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            if (this.dataset.view === 'list') {
                filesContainer.classList.add('list-view');
            } else {
                filesContainer.classList.remove('list-view');
            }
        });
    });
</script>
{% endblock %}
